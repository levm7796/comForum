<? namespace Bitrix\Main\Security\W;$GLOBALS['____439600361']= array(base64_decode('d'.'GltZQ=='),base64_decode('dG'.'lt'.'ZQ=='),base64_decode('anNvbl'.'9'.'kZW'.'N'.'vZGU='),base64_decode('YXJyYXlfb'.'WVyZ'.'2U='),base64_decode(''.'am'.'9pb'.'g=='),base64_decode('am9pbg'.'=='),base64_decode(''.'am9'.'p'.'bg=='),base64_decode('YXJyYXlfcG'.'9'.'w'),base64_decode('Y'.'XJ'.'yYXl'.'f'.'c2h'.'pZnQ='),base64_decode('Y'.'XJyYXlf'.'c2hpZnQ='),base64_decode('YX'.'J'.'y'.'Y'.'Xlfc'.'2hp'.'Z'.'nQ='),base64_decode(''.'YX'.'J'.'yYXl'.'fc2hpZnQ='),base64_decode('YXJy'.'Y'.'Xl'.'f'.'bWVyZ2U='),base64_decode('aX'.'NfYXJyYXk'.'='),base64_decode('Y'.'XJyYXlfbWVy'.'Z2U='),base64_decode('aW5fYXJy'.'YXk='),base64_decode('a'.'W'.'5f'.'YXJyY'.'Xk'.'='),base64_decode('aW5fYXJy'.'YX'.'k='),base64_decode('a'.'W'.'5'.'fY'.'XJyYXk='),base64_decode('aW'.'5fYXJyYXk='),base64_decode('dGltZQ='.'='),base64_decode('d'.'GltZQ='.'='),base64_decode(''.'YXJ'.'yYXlf'.'bWFw'),base64_decode('anNvbl9lbmNvZ'.'GU='),base64_decode('anNvbl9'.'l'.'bmNvZ'.'GU='),base64_decode('am9pbg=='));if(!function_exists(__NAMESPACE__.'\\___1677007514')){function ___1677007514($_804638992){static $_792122352= false; if($_792122352 == false) $_792122352=array('V1dBTExf'.'T'.'E9DSw==','c2V'.'jdXJp'.'dHk=','Y'.'2FjaG'.'U=','dHR'.'s','REFUQQ==','eyI'.'=',''.'V1dBTEx'.'fTE9'.'DS'.'w==','c2'.'VjdXJ'.'p'.'dHk=','U0'.'V'.'DVVJJVFlf'.'V1dB'.'TExfRVhD'.'RV'.'BUSU9O','RkFJT'.'F9D'.'SEVD'.'S'.'0'.'lORw'.'==','Q'.'2'.'F'.'uIG5'.'vdCBleGVjdXRlIH'.'d3Y'.'Wx'.'sIHJ1bGVzOiA'.'=',''.'IFRyYWNl'.'OiA=','Uk'.'VRVUVTVF9VU'.'kk'.'=','a2V5cw='.'=','dm'.'Fsd'.'WVz',''.'U0VDVVJ'.'JVFlfV'.'1d'.'BTExf'.'TU9E'.'S'.'UZZ','L'.'g==','U0VD'.'VV'.'J'.'J'.'VFl'.'fV1d'.'BT'.'ExfVU5TRVQ=','Lg==','U'.'0'.'VDVVJJVFlf'.'V1d'.'BT'.'Ex'.'fRVhJVA==','Lg==','Z2xv'.'YmFs','a2V5c'.'w='.'=',''.'dmFsdWVz',''.'Z2'.'V0','Z2V0',''.'cG9zdA==','cG9zdA==','Y29va2ll','Y'.'29v'.'a2ll','c'.'mVxd'.'WVzdA==',''.'cm'.'VxdWVz'.'dA'.'='.'=',''.'Z2'.'xvY'.'mFs','Z2xv'.'YmFs','b'.'WFpbl9zZWM=','V1dBTExfQUNUVUFM'.'SVpFX'.'1JVTEVT','dg==',''.'d'.'m'.'Vy'.'c2lvbg='.'=','aQ'.'==','aXNJb'.'nN0YWx'.'s'.'Z'.'WQ=','c29ja'.'2V0VG'.'ltZW91dA==','c3RyZWFtVGltZW91'.'d'.'A==',''.'KCc=','ZGF'.'0YQ==',''.'JywgJw==','bW9kdWxl',''.'Jy'.'w'.'gJw'.'='.'=',''.'b'.'W9kdWxlX'.'3ZlcnNpb24=','Jyk=','LCA=',''.'U0'.'VD'.'VVJJVFlfV1d'.'BTE'.'xfRVhDRVBUSU9O',''.'bWFpbg==','RkFJTF9'.'SR'.'UZS'.'R'.'VNISU5H','Q2FuIG5vdCB'.'yZW'.'ZyZXNoIHd'.'3YWxsIHJ1b'.'GVzOiA=','I'.'FRy'.'YWNl'.'Oi'.'A=','ZGF0YQ==',''.'eyI=',''.'LS0tLS1C'.'RU'.'dJTiBQ'.'VUJMSUMgS0V'.'ZLS0tLS0=','Ck1JSUJJakFOQmdrcWhr'.'aU'.'c5dzB'.'CQV'.'FFRkFBT0'.'NBU'.'ThBTU'.'lJQkNnS0NBUUVBcThRRTBIam1ISl'.'VTdFdWNm4wemEKUlZvTHgwMkt6Ym'.'Zy'.'Y'.'lMvU'.'DZzV'.'2F4VHp'.'3OFNlR1R0YlRDT3'.'JwSGk1'.'UUY2'.'T1J'.'5al'.'ovWHh6L0tMV'.'T'.'F'.'HYm'.'9mOUN'.'a'.'Mwo0'.'ejdTa'.'3FVdD'.'Y'.'2a'.'WJY'.'dk9GQng0Zn'.'cvQVBQ'.'UkdEcXRtMG'.'5EM2ZnR3N'.'1M'.'1'.'JlUGd3'.'Mjl'.'pOCt2bTdtdEJ'.'LSlVZbDRyClZwYjZz'.'Z'.'lpFV'.'DlLRWI2VDF'.'IRFltRXZjMW'.'hxL'.'2lp'.'d'.'Xl4'.'T'.'HJaWmk1UTZVZmY0VUV2'.'V'.'E'.'k'.'rNjhzc0ZSa'.'1Er'.'b3'.'dUUnkKZU9JT'.'WJGaE0vVVRtZl'.'Z'.'ZYlRSRn'.'kyb1'.'V'.'ROFd'.'Ne'.'mEybk'.'o'.'1U'.'2Fo'.'emkxV'.'U'.'tPMWp'.'B'.'a'.'lhUUFJye'.'m'.'M3QWp1NjM5aj'.'F'.'P'.'MApwcHFmbTV'.'4Z1dsRkF'.'K'.'a'.'0hRVGdiZ'.'GQ1Q'.'Vd'.'x'.'REZRa3Q5'.'S'.'Etr'.'WStUbmZCTEdWTX'.'ZWe'.'VB'.'3VEhOV1FZQXc0eHBnL'.'3d'.'B'.'Cl'.'p3'.'SU'.'RBUUFC'.'Ci0tL'.'S0t'.'RU5EIFBVQk'.'xJ'.'Qy'.'BLRVktLS0t'.'LQ==');return base64_decode($_792122352[$_804638992]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; class WWall{ const CACHE_RULES_TTL= 10800; private static $_1262229366= 'https://wwall.bitrix.info/rules.php'; protected $_303270930= true; public function handle(){ try{  $_439961373= Cache::createInstance(); $_1096372948= false; if($_439961373->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_117552970= $_439961373->getVars(); if($GLOBALS['____439600361'][0]()- $_117552970> round(0+6.6666666666667+6.6666666666667+6.6666666666667)){  $_134960588= Application::getConnection(); $_714949288= RuleRecordTable::getTableName(); $_134960588->truncateTable($_714949288); RuleRecordTable::cleanCache(); $_439961373->clean(___1677007514(0), ___1677007514(1));}} elseif($_439961373->startDataCache()){  $_439961373->endDataCache($GLOBALS['____439600361'][1]()); $_1096372948= true;}  $_182651809= RuleRecordTable::getList([ ___1677007514(2) =>[___1677007514(3) => round(0+1800+1800)* round(0+12+12)* round(0+1.4+1.4+1.4+1.4+1.4)]])->fetchAll(); foreach($_182651809 as $_2136965970){ $_495184588= new PublicKeyCipher; $_353660579= $_495184588->decrypt($_2136965970[___1677007514(4)], static::__908455026()); if(!str_starts_with($_353660579, ___1677007514(5))){ continue;} $_1803075461= $GLOBALS['____439600361'][2]($_353660579, true); if(!empty($_1803075461)){ $_2029944423= Rule::make($_1803075461); $_2095869960= $this->handleRule($_2029944423); $this->applyHandlingResults($_2095869960);}}  if($_1096372948){ $_439961373->clean(___1677007514(6), ___1677007514(7));}} catch(\Throwable $_2056549909){ $this->logEvent( ___1677007514(8), ___1677007514(9), ___1677007514(10). $_2056549909->getMessage(). ___1677007514(11). $_2056549909->getTraceAsString());}}  public function handleRule(Rule $_2029944423): array{ $_2095869960=[]; if($_2029944423->matchPath($_SERVER[___1677007514(12)])){  $_706219084= $this->getContextElements($_2029944423->getContext()); foreach($_706219084 as $_963447501 => &$_1116789732){ $_2095869960= $GLOBALS['____439600361'][3]($_2095869960, $this->recursiveContextKeyHandle($_963447501, $_1116789732,[], $_2029944423));}} return $_2095869960;}  public function applyHandlingResults(array $_2095869960){ $_706219084= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_2095869960 as $_1793232725){ $_1116789732=& $_706219084[$_1793232725->getContextName()]; $_198779365= $_1793232725->getRuleResult(); $_2029944423= $_1793232725->getRule(); if($_198779365 instanceof ModifyResult){ if($_2029944423->getProcess() === ___1677007514(13)){  static::rewriteContextKey( $_1793232725->getContextName(), $_1116789732, $_1793232725->getContextKey(), $_198779365->getCleanValue());} elseif($_2029944423->getProcess() === ___1677007514(14)){ static::rewriteContextValue( $_1793232725->getContextName(), $_1116789732, $_1793232725->getContextKey(), $_198779365->getCleanValue());} $this->logEvent( ___1677007514(15), $_1793232725->getContextName(), $GLOBALS['____439600361'][4](___1677007514(16), $_1793232725->getContextKey()));} elseif($_198779365 instanceof CheckResult &&!$_198779365->isSuccess()){ if($_198779365->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_1793232725->getContextName(), $_1116789732, $_1793232725->getContextKey(),); $this->logEvent( ___1677007514(17), $_1793232725->getContextName(), $GLOBALS['____439600361'][5](___1677007514(18), $_1793232725->getContextKey()));} elseif($_198779365->getAction() === RuleAction::EXIT){ $this->logEvent( ___1677007514(19), $_1793232725->getContextName(), $GLOBALS['____439600361'][6](___1677007514(20), $_1793232725->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_303270930= false;} protected function rewriteContextKey($_963447501, &$_1116789732, $_2099835208, $_1320634525){ $_1761125862= $_2099835208;  $GLOBALS['____439600361'][7]($_1761125862); $_1761125862[]= $_1320634525; if($_963447501 === ___1677007514(21)){ $_1144709896= $GLOBALS['____439600361'][8]($_2099835208); $GLOBALS['____439600361'][9]($_1761125862); if(empty($_2099835208)){ $GLOBALS[$_1320634525]= $GLOBALS[$_1144709896]; unset($GLOBALS[$_1144709896]);} else{ $_1116789732=& $GLOBALS[$_1144709896]; $_846206430= ArrayHelper::getByNestedKey($_1116789732, $_2099835208);  ArrayHelper::setByNestedKey($_1116789732, $_1761125862, $_846206430);  ArrayHelper::unsetByNestedKey($_1116789732, $_2099835208);}} else{ $_846206430= ArrayHelper::getByNestedKey($_1116789732, $_2099835208);  ArrayHelper::setByNestedKey($_1116789732, $_1761125862, $_846206430);  ArrayHelper::unsetByNestedKey($_1116789732, $_2099835208);}} protected function rewriteContextValue($_963447501, &$_1116789732, $_1412837485, $_846206430){ if($_963447501 === 'global'){ $_1144709896= $GLOBALS['____439600361'][10]($_1412837485); if(empty($_1412837485)){ $GLOBALS[$_1144709896]= $_846206430;} else{ $_1116789732=& $GLOBALS[$_1144709896]; ArrayHelper::setByNestedKey($_1116789732, $_1412837485, $_846206430);}} else{  ArrayHelper::setByNestedKey($_1116789732, $_1412837485, $_846206430);}} protected function unsetContextValue($_963447501, &$_1116789732, $_1412837485){ if($_963447501 === 'global'){ $_1144709896= $GLOBALS['____439600361'][11]($_1412837485); if(empty($_1412837485)){ unset($GLOBALS[$_1144709896]);} else{ $_1116789732=& $GLOBALS[$_1144709896]; ArrayHelper::unsetByNestedKey($_1116789732, $_1412837485);}} else{ ArrayHelper::unsetByNestedKey($_1116789732, $_1412837485);}}  protected function recursiveContextKeyHandle(string $_963447501, array &$_1116789732, array $_1264477919, Rule $_2029944423): array{  $_2095869960=[]; foreach($_1116789732 as $_952844800 => $_846206430){ $_1412837485= $GLOBALS['____439600361'][12]($_1264477919,[$_952844800]); if($_2029944423->matchKey($_1412837485)){  if($_2029944423->getProcess() === ___1677007514(22)){ $_198779365= $_2029944423->evaluate($_952844800);} elseif($_2029944423->getProcess() === ___1677007514(23)){ $_198779365= $_2029944423->evaluateValue($_846206430);}  if(!empty($_198779365) && $_198779365 instanceof RuleResult){ $_2095869960[]= new HandlingResult($_963447501, $_1412837485, $_198779365, $_2029944423);}}  if($GLOBALS['____439600361'][13]($_846206430)){ $_2095869960= $GLOBALS['____439600361'][14]($_2095869960, $this->recursiveContextKeyHandle( $_963447501, $_1116789732[$_952844800], $_1412837485, $_2029944423));}} return $_2095869960;} protected function getContextElements(array $_289724332){ $_1898842905=[]; if($GLOBALS['____439600361'][15](___1677007514(24), $_289724332, true)){ $_1898842905[___1677007514(25)]= &$_GET;} if($GLOBALS['____439600361'][16](___1677007514(26), $_289724332, true)){ $_1898842905[___1677007514(27)]= &$_POST;} if($GLOBALS['____439600361'][17](___1677007514(28), $_289724332, true)){ $_1898842905[___1677007514(29)]= &$_COOKIE;} if($GLOBALS['____439600361'][18](___1677007514(30), $_289724332, true)){ $_1898842905[___1677007514(31)]= &$_REQUEST;} if($GLOBALS['____439600361'][19](___1677007514(32), $_289724332, true)){ $_1898842905[___1677007514(33)]= $GLOBALS;} return $_1898842905;} public static function refreshRules(){ try{ $_1904742083= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____439600361'][20]()- $_1904742083)< static::CACHE_RULES_TTL){ return;} Option::set(___1677007514(34), ___1677007514(35), $GLOBALS['____439600361'][21]()); $_1340652611= null;  $_1377864722= $GLOBALS['____439600361'][22](function($_1764718356){ return[___1677007514(36) => $_1764718356[___1677007514(37)], ___1677007514(38) => (int) $_1764718356[___1677007514(39)]];}, ModuleManager::getModulesFromDisk());  $_460727596= new HttpClient([ ___1677007514(40) => round(0+5), ___1677007514(41) => round(0+1.25+1.25+1.25+1.25)]); $_479345156= $_460727596->post( static::$_1262229366,[ 'modules' => $GLOBALS['____439600361'][23]($_1377864722), 'license' => Application::getInstance()->getLicense()->getHashLicenseKey()]); if($_460727596->getStatus() == round(0+200) &&!empty($_479345156)){ $_1340652611= Json::decode($_479345156);}  if($_1340652611 !== null){ $_134960588= Application::getConnection(); $_714949288= RuleRecordTable::getTableName(); if(!empty($_1340652611)){ foreach($_1340652611 as $_1691680807){ if(!static::checkRuleSign($_1691680807)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____439600361'][24]($_1691680807));}}}  $_134960588->truncateTable($_714949288);  if(!empty($_1340652611)){ $_1469750358=[]; foreach($_1340652611 as $_1691680807){ $_1469750358[]= ___1677007514(42). $_134960588->getSqlHelper()->forSql($_1691680807[___1677007514(43)]). ___1677007514(44). $_134960588->getSqlHelper()->forSql($_1691680807[___1677007514(45)]). ___1677007514(46). $_134960588->getSqlHelper()->forSql($_1691680807[___1677007514(47)]). ___1677007514(48);} $_945686836= $GLOBALS['____439600361'][25](___1677007514(49), $_1469750358);  $_134960588->query("INSERT INTO {$_714949288} (DATA, MODULE, MODULE_VERSION) VALUES {$_945686836}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_2056549909){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___1677007514(50), ___1677007514(51), ___1677007514(52), ___1677007514(53). $_2056549909->getMessage(). ___1677007514(54). $_2056549909->getTraceAsString());}} protected static function checkRuleSign($_2029944423){ $_495184588= new PublicKeyCipher; $_1803075461= $_495184588->decrypt($_2029944423[___1677007514(55)], static::__908455026()); return str_starts_with($_1803075461, ___1677007514(56));} private static function __908455026(){ $_2067249682= ''; $_2067249682 .= ___1677007514(57); $_2067249682 .= ___1677007514(58); return $_2067249682;} protected function logEvent($_1572295235, $_777258397, $_1155037011){ if($this->_303270930){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_1572295235, 'main', $_777258397, $_1155037011);}}}?>